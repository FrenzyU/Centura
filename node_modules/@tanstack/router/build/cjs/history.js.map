{"version":3,"file":"history.js","sources":["../../src/history.ts"],"sourcesContent":["// While the public API was clearly inspired by the \"history\" npm package,\n// This implementation attempts to be more lightweight by\n// making assumptions about the way TanStack Router works\n\nimport { match } from 'assert'\n\nexport interface RouterHistory {\n  location: RouterLocation\n  listen: (cb: () => void) => () => void\n  push: (path: string, state: any) => void\n  replace: (path: string, state: any) => void\n  go: (index: number) => void\n  back: () => void\n  forward: () => void\n}\n\nexport interface ParsedPath {\n  href: string\n  pathname: string\n  search: string\n  hash: string\n}\n\nexport interface RouterLocation extends ParsedPath {\n  state: any\n}\n\nconst popStateEvent = 'popstate'\n\nfunction createHistory(opts: {\n  getLocation: () => RouterLocation\n  listener: (onUpdate: () => void) => () => void\n  pushState: (path: string, state: any) => void\n  replaceState: (path: string, state: any) => void\n  go: (n: number) => void\n  back: () => void\n  forward: () => void\n}): RouterHistory {\n  let currentLocation = opts.getLocation()\n  let unsub = () => {}\n  let listeners = new Set<() => void>()\n\n  const onUpdate = () => {\n    currentLocation = opts.getLocation()\n\n    listeners.forEach((listener) => listener())\n  }\n\n  return {\n    get location() {\n      return currentLocation\n    },\n    listen: (cb: () => void) => {\n      if (listeners.size === 0) {\n        unsub = opts.listener(onUpdate)\n      }\n      listeners.add(cb)\n\n      return () => {\n        listeners.delete(cb)\n        if (listeners.size === 0) {\n          unsub()\n        }\n      }\n    },\n    push: (path: string, state: any) => {\n      opts.pushState(path, state)\n      onUpdate()\n    },\n    replace: (path: string, state: any) => {\n      opts.replaceState(path, state)\n      onUpdate()\n    },\n    go: (index) => {\n      opts.go(index)\n      onUpdate()\n    },\n    back: () => {\n      opts.back()\n      onUpdate()\n    },\n    forward: () => {\n      opts.forward()\n      onUpdate()\n    },\n  }\n}\n\nexport function createBrowserHistory(opts?: {\n  getHref?: () => string\n  createHref?: (path: string) => string\n}): RouterHistory {\n  const getHref =\n    opts?.getHref ??\n    (() =>\n      `${window.location.pathname}${window.location.hash}${window.location.search}`)\n  const createHref = opts?.createHref ?? ((path) => path)\n  const getLocation = () => parseLocation(getHref(), history.state)\n\n  return createHistory({\n    getLocation,\n    listener: (onUpdate) => {\n      window.addEventListener(popStateEvent, onUpdate)\n      return () => {\n        window.removeEventListener(popStateEvent, onUpdate)\n      }\n    },\n    pushState: (path, state) => {\n      window.history.pushState(\n        { ...state, key: createRandomKey() },\n        '',\n        createHref(path),\n      )\n    },\n    replaceState: (path, state) => {\n      window.history.replaceState(\n        { ...state, key: createRandomKey() },\n        '',\n        createHref(path),\n      )\n    },\n    back: () => window.history.back(),\n    forward: () => window.history.forward(),\n    go: (n) => window.history.go(n),\n  })\n}\n\nexport function createHashHistory(): RouterHistory {\n  return createBrowserHistory({\n    getHref: () => window.location.hash.substring(1),\n    createHref: (path) => `#${path}`,\n  })\n}\n\nexport function createMemoryHistory(\n  opts: {\n    initialEntries: string[]\n    initialIndex?: number\n  } = {\n    initialEntries: ['/'],\n  },\n): RouterHistory {\n  const entries = opts.initialEntries\n  let index = opts.initialIndex ?? entries.length - 1\n  let currentState = {}\n\n  const getLocation = () => parseLocation(entries[index]!, currentState)\n\n  return createHistory({\n    getLocation,\n    listener: () => {\n      return () => {}\n    },\n    pushState: (path, state) => {\n      currentState = {\n        ...state,\n        key: createRandomKey(),\n      }\n      entries.push(path)\n      index++\n    },\n    replaceState: (path, state) => {\n      currentState = {\n        ...state,\n        key: createRandomKey(),\n      }\n      entries[index] = path\n    },\n    back: () => {\n      index--\n    },\n    forward: () => {\n      index = Math.min(index + 1, entries.length - 1)\n    },\n    go: (n) => window.history.go(n),\n  })\n}\n\nfunction parseLocation(href: string, state: any): RouterLocation {\n  let hashIndex = href.indexOf('#')\n  let searchIndex = href.indexOf('?')\n\n  return {\n    href,\n    pathname: href.substring(\n      0,\n      hashIndex > 0\n        ? searchIndex > 0\n          ? Math.min(hashIndex, searchIndex)\n          : hashIndex\n        : searchIndex > 0\n        ? searchIndex\n        : href.length,\n    ),\n    hash: hashIndex > -1 ? href.substring(hashIndex, searchIndex) : '',\n    search: searchIndex > -1 ? href.substring(searchIndex) : '',\n    state,\n  }\n}\n\n// Thanks co-pilot!\nfunction createRandomKey() {\n  return (Math.random() + 1).toString(36).substring(7)\n}\n"],"names":["popStateEvent","createHistory","opts","currentLocation","getLocation","unsub","listeners","Set","onUpdate","forEach","listener","location","listen","cb","size","add","delete","push","path","state","pushState","replace","replaceState","go","index","back","forward","createBrowserHistory","getHref","window","pathname","hash","search","createHref","parseLocation","history","addEventListener","removeEventListener","key","createRandomKey","n","createHashHistory","substring","createMemoryHistory","initialEntries","entries","initialIndex","length","currentState","Math","min","href","hashIndex","indexOf","searchIndex","random","toString"],"mappings":"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"}