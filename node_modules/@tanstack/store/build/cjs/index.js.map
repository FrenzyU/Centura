{"version":3,"file":"index.js","sources":["../../src/index.ts"],"sourcesContent":["import { produce, setAutoFreeze } from 'immer'\n\nsetAutoFreeze(false)\n\n// interface StoreOptions {\n//   onSubscribe?: () => (() => void) | void\n// }\n\nexport class Store<TState> {\n  listeners = new Set<(next: TState, prev: TState) => void>()\n  state: TState\n  // options?: StoreOptions\n  batching = false\n  queue: ((...args: any[]) => void)[] = []\n\n  constructor(\n    initialState: TState,\n    // options?: StoreOptions\n  ) {\n    this.state = initialState\n    // this.options = options\n  }\n\n  subscribe = (listener: (next: TState, prev: TState) => void) => {\n    this.listeners.add(listener)\n    // const unsub = this.options?.onSubscribe?.()\n    return () => {\n      this.listeners.delete(listener)\n      // unsub?.()\n    }\n  }\n\n  setState = (updater: (cb: TState) => void) => {\n    const previous = this.state\n    this.state = produce((d) => {\n      updater(d)\n    })(previous)\n\n    this.queue.push(() =>\n      this.listeners.forEach((listener) => listener(this.state, previous)),\n    )\n    this.#flush()\n  }\n\n  #flush = () => {\n    if (this.batching) return\n    this.queue.forEach((cb) => cb())\n    this.queue = []\n  }\n\n  batch = (cb: () => void) => {\n    this.batching = true\n    cb()\n    this.batching = false\n    this.#flush()\n  }\n}\n"],"names":["setAutoFreeze","Store","listeners","Set","batching","queue","constructor","initialState","state","subscribe","listener","add","delete","setState","updater","previous","produce","d","push","forEach","cb","batch"],"mappings":";;;;;;;;;;;;;;;;AAEAA,mBAAa,CAAC,KAAK,CAAC,CAAA;;AAEpB;AACA;AACA;;AAEO,MAAMC,KAAK,CAAS;EACzBC,SAAS,GAAG,IAAIC,GAAG,EAAwC,CAAA;AAE3D;AACAC,EAAAA,QAAQ,GAAG,KAAK,CAAA;AAChBC,EAAAA,KAAK,GAAiC,EAAE,CAAA;AAExCC,EAAAA,WAAW,CACTC,YAAAA;AACA;IACA;IACA,IAAI,CAACC,KAAK,GAAGD,YAAY,CAAA;AACzB;AACF,GAAA;;EAEAE,SAAS,GAAIC,QAA8C,IAAK;AAC9D,IAAA,IAAI,CAACR,SAAS,CAACS,GAAG,CAACD,QAAQ,CAAC,CAAA;AAC5B;AACA,IAAA,OAAO,MAAM;AACX,MAAA,IAAI,CAACR,SAAS,CAACU,MAAM,CAACF,QAAQ,CAAC,CAAA;AAC/B;KACD,CAAA;GACF,CAAA;;EAEDG,QAAQ,GAAIC,OAA6B,IAAK;AAC5C,IAAA,MAAMC,QAAQ,GAAG,IAAI,CAACP,KAAK,CAAA;AAC3B,IAAA,IAAI,CAACA,KAAK,GAAGQ,aAAO,CAAEC,CAAC,IAAK;MAC1BH,OAAO,CAACG,CAAC,CAAC,CAAA;KACX,CAAC,CAACF,QAAQ,CAAC,CAAA;IAEZ,IAAI,CAACV,KAAK,CAACa,IAAI,CAAC,MACd,IAAI,CAAChB,SAAS,CAACiB,OAAO,CAAET,QAAQ,IAAKA,QAAQ,CAAC,IAAI,CAACF,KAAK,EAAEO,QAAQ,CAAC,CAAC,CACrE,CAAA;IACD,IAAI,CAAC,MAAM,EAAE,CAAA;GACd,CAAA;EAED,MAAM,GAAG,MAAM;IACb,IAAI,IAAI,CAACX,QAAQ,EAAE,OAAA;IACnB,IAAI,CAACC,KAAK,CAACc,OAAO,CAAEC,EAAE,IAAKA,EAAE,EAAE,CAAC,CAAA;IAChC,IAAI,CAACf,KAAK,GAAG,EAAE,CAAA;GAChB,CAAA;EAEDgB,KAAK,GAAID,EAAc,IAAK;IAC1B,IAAI,CAAChB,QAAQ,GAAG,IAAI,CAAA;AACpBgB,IAAAA,EAAE,EAAE,CAAA;IACJ,IAAI,CAAChB,QAAQ,GAAG,KAAK,CAAA;IACrB,IAAI,CAAC,MAAM,EAAE,CAAA;GACd,CAAA;AACH;;;;"}